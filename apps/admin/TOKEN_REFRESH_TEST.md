# Token无感刷新功能测试说明

## 功能概述

实现了access_token的无感刷新机制，当token过期时自动刷新，用户无需重新登录。

## 实现特性

1. **自动检测认证错误**：当API返回`{code: 4000, message: "Unauthorized"}`时，自动触发token刷新
2. **请求队列机制**：防止多个请求同时触发token刷新
3. **自动重试**：刷新成功后自动重试原始请求
4. **失败处理**：刷新失败时自动登出并跳转到登录页

## 后端API响应格式

后端使用统一的响应格式：
```json
{
  "code": 4000,           // 错误码，4000表示认证错误
  "data": null,           // 数据
  "message": "Unauthorized", // 错误信息
  "requestId": "12",      // 请求ID
  "timestamp": "2025-10-03T08:02:44.900Z"
}
```

**重要**：后端返回HTTP 200状态码，但通过响应体中的`code`字段表示错误类型。

## 测试步骤

### 1. 正常登录测试

1. 启动后端服务和管理后台
2. 使用有效账号登录
3. 验证token正确保存到localStorage

### 2. Token刷新测试

#### 方法一：模拟token过期
1. 登录成功后，在浏览器控制台执行：
```javascript
// 修改token使其过期
localStorage.setItem('access_token', 'expired_token')
```
2. 触发任意API请求（如访问需要认证的页面）
3. 观察网络请求，应该看到：
   - 原始请求返回401
   - 自动发送刷新token请求
   - 使用新token重试原始请求
   - 请求成功完成

#### 方法二：等待token自然过期
1. 登录成功后等待token自然过期（根据后端配置的过期时间）
2. 在token即将过期时触发API请求
3. 验证自动刷新功能

### 3. 并发请求测试

1. 在token过期时同时发送多个API请求
2. 验证只有一个刷新请求被发送
3. 验证所有请求都能正确重试

### 4. 刷新失败测试

1. 删除refresh_token或使其无效
2. 触发API请求
3. 验证自动登出并跳转到登录页

## 预期行为

### 成功场景
- ✅ 认证错误时自动刷新token（code: 4000, message: "Unauthorized"）
- ✅ 刷新成功后自动重试原始请求
- ✅ 用户无感知，无需重新登录
- ✅ 多个并发请求只触发一次刷新

### 失败场景
- ✅ 刷新失败时自动登出
- ✅ 跳转到登录页面
- ✅ 清除所有认证信息

## 技术实现

### 核心组件

1. **auth.ts工具函数**：
   - `refreshToken()`: 刷新token
   - `isTokenValid()`: 检查token有效性
   - `isTokenExpiring()`: 检查token是否即将过期

2. **API拦截器**：
   - 请求拦截器：自动添加Authorization头
   - 响应拦截器：处理401错误和token刷新

3. **请求队列机制**：
   - 防止重复刷新
   - 确保所有等待的请求都能获得新token

## 注意事项

- 确保后端API的refresh接口正常工作
- 确保refresh_token有足够的有效期
- 测试时注意观察浏览器控制台的日志输出
- 可以通过Network面板观察请求的完整流程
